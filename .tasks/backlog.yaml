# Task Backlog
# Remaining pending tasks sorted by priority

tasks:
  - task_id: TASK-035
    spec_id: SPEC-security-zt-1
    title: "Implement Cloudflare Zero Trust Access for UI and API"
    priority: 1
    status: pending
    dependencies: []
    estimated_effort: 4 hours
    description: |
      Secure the entire application by replacing the static token authentication with Cloudflare Zero Trust Access. This involves validating a JWT from Cloudflare to authorize requests to both the frontend and the backend API.

      **Part 1: Manual Cloudflare Configuration (User Task)**
      1.  **Setup Identity Provider:** Configure an IdP (e.g., Google, GitHub) in the Zero Trust dashboard.
      2.  **Create Access Application:** Create a "Self-hosted" application, defining the domain to protect.
      3.  **Create Access Policy:** Define rules for who can access the application.
      4.  **Enable API JWT:** In the application's settings, enable "App-to-App API access" and note the **Audience (AUD) Tag**.

      **Part 2: Worker Implementation (Agent Task)**
      1.  **Add Secrets:** Define two new secrets for the worker:
          - `CF_ACCESS_TEAM_DOMAIN`: Your Cloudflare team domain (e.g., `your-team.cloudflareaccess.com`).
          - `CF_ACCESS_AUD_TAG`: The Audience (AUD) Tag from the Access Application settings.
      2.  **Implement JWT Validation Middleware:**
          - Create a new module `src/auth/zt-validator.ts`.
          - This module will export a middleware function that:
            a. Extracts the `CF_Authorization` JWT from request headers.
            b. Fetches the public signing keys from `https://{CF_ACCESS_TEAM_DOMAIN}/cdn-cgi/access/certs`.
            c. Uses the `jose` library to verify the JWT's signature, issuer, and audience (`aud` claim).
      3.  **Integrate Middleware:**
          - Apply the JWT validation middleware to all protected API routes (e.g., in `src/api/admin-handler.ts` and `src/index.ts`).
          - Replace the old `ADMIN_TOKEN` check with this new middleware.
      4.  **Deprecate Old Token:**
          - Once verified, remove the `ADMIN_TOKEN` logic, secret, and documentation.
      5.  **Update Documentation:**
          - Update `README.md` with instructions for setting up Cloudflare Zero Trust for authentication.
    test_refs:
      - "TEST-zt-auth-1"
      - "TEST-zt-auth-2"
      - "TEST-zt-auth-3"
    notes: |
      This change fundamentally improves the security posture of the application, moving from a shared static secret to per-user, identity-based, short-lived credentials managed by Cloudflare.

  - task_id: TASK-034
    spec_id: SPEC-embedding-pipeline-1
    title: "Integrate Cloudflare AI Gateway for all OpenAI Calls"
    priority: 2
    status: pending
    dependencies: []
    estimated_effort: 2.5 hours
    description: |
      Refactor the OpenAI client initialization to create a centralized, reusable factory. This will route all OpenAI API calls (current embedding, future chat, etc.) through Cloudflare's AI Gateway for improved caching, rate limiting, and analytics.
    # ... (rest of the task description)

  - task_id: TASK-033
    spec_id: null
    title: "Refactor folder structure: rename src/ to worker/"
    priority: 3
    status: pending
    dependencies:
      - TASK-032
    estimated_effort: 1.5 hours
    description: |
      Refactor project folder structure for clarity.
    # ... (rest of the task description)